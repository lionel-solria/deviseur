<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Générateur de devis</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" integrity="sha512-vG6V9H2m6q+UpBAkLTlaX2UjsFvdcGaVbL50DJBSSTXobHxPPH/FkOFjHlxkAt2bQVWwtIg9Y9ycYzaO+em1eg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js" integrity="sha512-VEt8Tk1bNnAdNmaMibWroziW31dJqbZL+fdum4R0YWCurwXlmnguplB9Eq+nFF8+N7D3CofJUN6abWl06Ho9mQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <style>
      ::selection {
        background-color: #2563eb;
        color: #fff;
      }

      .line-clamp-3 {
        display: -webkit-box;
        -webkit-line-clamp: 3;
        -webkit-box-orient: vertical;
        overflow: hidden;
      }
    </style>
  </head>
  <body class="bg-slate-100 text-slate-800 min-h-screen">
    <nav class="fixed inset-x-0 top-0 z-40 bg-white shadow-sm">
      <div class="mx-auto flex max-w-7xl items-center justify-between px-4 py-4">
        <div class="flex items-center gap-3">
          <div class="flex h-10 w-10 items-center justify-center rounded-full bg-blue-600 text-white font-semibold">DV</div>
          <div>
            <p class="text-lg font-semibold text-slate-900">Deviseur Express</p>
            <p class="text-sm text-slate-500">Créez vos devis en quelques clics</p>
          </div>
        </div>
        <button id="generate-pdf" class="rounded-md bg-blue-600 px-4 py-2 text-sm font-semibold text-white shadow-sm transition hover:bg-blue-700 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-blue-600">
          Générer le devis PDF
        </button>
      </div>
    </nav>
    <main class="mx-auto flex max-w-7xl flex-col gap-8 px-4 pb-20 pt-28 lg:grid lg:grid-cols-[2fr,1fr]">
      <section aria-labelledby="catalogue-title" class="flex flex-col gap-6">
        <header class="flex flex-col gap-4 rounded-2xl bg-white p-6 shadow-sm">
          <div>
            <h1 id="catalogue-title" class="text-2xl font-semibold text-slate-900">Catalogue produits</h1>
            <p class="mt-1 text-sm text-slate-500">
              Parcourez le catalogue et ajoutez les articles souhaités directement à votre devis.
            </p>
          </div>
          <div class="relative">
            <label for="search" class="sr-only">Rechercher un produit</label>
            <input
              id="search"
              type="search"
              placeholder="Rechercher par nom ou référence..."
              class="w-full rounded-xl border border-slate-200 bg-slate-50 py-3 pl-11 pr-4 text-sm text-slate-700 shadow-inner focus:border-blue-500 focus:bg-white focus:outline-none focus:ring-2 focus:ring-blue-500/20"
            />
            <svg class="pointer-events-none absolute left-3 top-1/2 h-5 w-5 -translate-y-1/2 text-slate-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="m21 21-4.35-4.35m0 0a7 7 0 1 0-9.9-9.9 7 7 0 0 0 9.9 9.9Z" />
            </svg>
          </div>
        </header>
        <div id="product-feedback" class="hidden rounded-2xl bg-amber-50 px-6 py-4 text-sm text-amber-700 shadow-sm"></div>
        <div id="product-grid" class="grid grid-cols-1 gap-5 sm:grid-cols-2 xl:grid-cols-3"></div>
      </section>
      <aside class="flex flex-col gap-4 rounded-2xl bg-white p-6 shadow-lg lg:sticky lg:top-28 lg:h-[calc(100vh-7rem)] lg:overflow-hidden">
        <header class="flex items-start justify-between gap-2">
          <div>
            <h2 class="text-xl font-semibold text-slate-900">Devis en cours</h2>
            <p class="text-sm text-slate-500">Ajustez les quantités et vérifiez les totaux en temps réel.</p>
          </div>
        </header>
        <div id="quote-empty" class="flex flex-1 flex-col items-center justify-center gap-3 rounded-xl border border-dashed border-slate-200 bg-slate-50 p-6 text-center text-sm text-slate-500">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="h-10 w-10 text-slate-300" fill="none" stroke="currentColor" stroke-width="1.5">
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6l4 2" />
            <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 19.5h15a1.5 1.5 0 0 0 1.5-1.5v-12A1.5 1.5 0 0 0 19.5 4.5h-15A1.5 1.5 0 0 0 3 6v12a1.5 1.5 0 0 0 1.5 1.5Z" />
          </svg>
          <p>Aucun article n'a encore été ajouté. Utilisez le bouton "Ajouter au devis" sur un produit.</p>
        </div>
        <div id="quote-list" class="hidden flex-1 space-y-4 overflow-y-auto pr-2"></div>
        <footer class="border-t border-slate-200 pt-4">
          <dl class="space-y-2 text-sm text-slate-600">
            <div class="flex items-center justify-between">
              <dt>Total HT</dt>
              <dd id="summary-subtotal" class="font-semibold text-slate-900">0,00 €</dd>
            </div>
            <div class="flex items-center justify-between gap-3">
              <dt class="flex-1">Remise (%)</dt>
              <dd class="flex items-center gap-2">
                <input id="discount" type="number" min="0" max="100" step="0.5" value="0" class="h-9 w-20 rounded-lg border border-slate-200 bg-white px-2 text-right text-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500/20" />
              </dd>
            </div>
            <div class="flex items-center justify-between">
              <dt>Montant remise</dt>
              <dd id="summary-discount" class="text-slate-900">-0,00 €</dd>
            </div>
            <div class="flex items-center justify-between">
              <dt>Base HT après remise</dt>
              <dd id="summary-net" class="text-slate-900">0,00 €</dd>
            </div>
            <div class="flex items-center justify-between">
              <dt>TVA (20%)</dt>
              <dd id="summary-vat" class="text-slate-900">0,00 €</dd>
            </div>
            <div class="flex items-center justify-between text-base font-semibold text-slate-900">
              <dt>Total TTC</dt>
              <dd id="summary-total">0,00 €</dd>
            </div>
          </dl>
        </footer>
      </aside>
    </main>
    <template id="product-card-template">
      <article class="group flex h-full flex-col overflow-hidden rounded-2xl bg-white shadow-sm transition hover:-translate-y-1 hover:shadow-md">
        <div class="relative h-48 w-full overflow-hidden bg-slate-100">
          <img class="product-image h-full w-full object-cover transition duration-300 group-hover:scale-105" alt="" />
          <div class="absolute inset-x-0 bottom-0 bg-gradient-to-t from-black/60 via-black/0 to-transparent p-3">
            <p class="product-reference text-xs font-medium uppercase tracking-wide text-white/70"></p>
          </div>
        </div>
        <div class="flex flex-1 flex-col gap-4 p-5">
          <div class="flex-1">
            <h3 class="product-name text-base font-semibold text-slate-900"></h3>
            <p class="product-description mt-2 line-clamp-3 text-sm text-slate-500"></p>
            <a class="product-link mt-3 inline-flex items-center gap-1 text-sm font-medium text-blue-600 transition hover:text-blue-700" target="_blank" rel="noopener">
              Voir la fiche
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="h-4 w-4" fill="none" stroke="currentColor" stroke-width="1.5">
                <path stroke-linecap="round" stroke-linejoin="round" d="m17 7-10 10" />
                <path stroke-linecap="round" stroke-linejoin="round" d="M8 7h9v9" />
              </svg>
            </a>
          </div>
          <div class="flex items-center justify-between">
            <div>
              <p class="product-price text-lg font-semibold text-blue-600"></p>
              <p class="product-unit text-xs text-slate-400"></p>
            </div>
            <button class="add-to-quote rounded-lg bg-blue-600 px-3 py-2 text-sm font-semibold text-white transition hover:bg-blue-700 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-blue-600">
              Ajouter au devis
            </button>
          </div>
        </div>
      </article>
    </template>
    <template id="quote-item-template">
      <div class="quote-row flex flex-col gap-3 rounded-xl border border-slate-200 bg-slate-50 p-4 text-sm text-slate-600">
        <div class="flex items-start justify-between gap-2">
          <div>
            <p class="quote-name font-semibold text-slate-900"></p>
            <p class="quote-reference text-xs uppercase tracking-wide text-slate-400"></p>
            <p class="quote-unit text-xs uppercase tracking-wide text-slate-400"></p>
          </div>
          <button class="remove-item text-xs font-semibold text-rose-500 transition hover:text-rose-600">Retirer</button>
        </div>
        <div class="flex flex-wrap items-center gap-3" data-role="quantity-container">
          <div class="flex items-center rounded-lg border border-slate-200 bg-white" data-role="unit-controls">
            <button class="decrease px-2 py-1 text-base text-slate-500 transition hover:text-slate-700">−</button>
            <span class="quantity min-w-[2.5rem] text-center text-sm font-semibold text-slate-900"></span>
            <button class="increase px-2 py-1 text-base text-slate-500 transition hover:text-slate-700">+</button>
          </div>
          <div class="hidden flex flex-wrap items-end gap-3" data-role="area-controls">
            <label class="flex flex-col text-xs font-medium text-slate-500">
              Longueur (m)
              <input type="number" min="0" step="0.01" class="length-input mt-1 h-9 w-24 rounded-lg border border-slate-200 bg-white px-2 text-right text-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500/20" />
            </label>
            <label class="flex flex-col text-xs font-medium text-slate-500">
              Largeur (m)
              <input type="number" min="0" step="0.01" class="width-input mt-1 h-9 w-24 rounded-lg border border-slate-200 bg-white px-2 text-right text-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500/20" />
            </label>
            <div class="flex flex-col">
              <span class="text-xs uppercase tracking-wide text-slate-400">Surface</span>
              <span class="area-value font-semibold text-blue-600"></span>
            </div>
          </div>
          <div class="flex flex-col">
            <span class="text-xs uppercase tracking-wide text-slate-400">PU HT</span>
            <span class="unit-price font-medium text-slate-900"></span>
          </div>
          <div class="flex flex-col">
            <span class="text-xs uppercase tracking-wide text-slate-400">Total ligne</span>
            <span class="line-total font-semibold text-blue-600"></span>
          </div>
        </div>
      </div>
    </template>
    <script>
      const catalogueUrl = './catalogue/import_items.csv';
      const defaultImage = 'https://via.placeholder.com/640x480.png?text=Image+indisponible';
      const currencyFormatter = new Intl.NumberFormat('fr-FR', { style: 'currency', currency: 'EUR' });
      const numberFormatter = new Intl.NumberFormat('fr-FR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
      const unitFormatter = new Intl.NumberFormat('fr-FR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
      const areaUnits = new Set(['m2', 'm²', 'metre carre', 'metres carres', 'mètre carré', 'mètres carrés']);
      const companyProfile = {
        name: 'Deviseur Express',
        legalName: 'Deviseur Express SAS',
        address: ['123 Rue Exemple', '75000 Paris', 'France'],
        email: 'contact@deviseur-express.fr',
        phone: '+33 1 23 45 67 89',
        website: 'www.deviseur-express.fr',
        registration: 'SIRET 123 456 789 00010',
        vatNumber: 'TVA FR12 345678900',
        bankDetails: 'IBAN FR76 3000 4000 5000 6000 7000 890 • BIC PSSTFRPPXXX',
        validity: '30 jours à compter de la date du devis',
        paymentTerms: 'Paiement à 30 jours fin de mois par virement bancaire.',
      };
      const clientProfile = {
        company: 'Client',
        contact: 'Nom du client',
        address: 'Adresse du client',
        city: 'Code postal - Ville',
        email: 'client@email.com',
      };

      const state = {
        catalogue: [],
        filtered: [],
        catalogueById: new Map(),
        quote: new Map(),
        discountRate: 0,
        vatRate: 0.2,
      };

      const elements = {
        search: document.getElementById('search'),
        productGrid: document.getElementById('product-grid'),
        productFeedback: document.getElementById('product-feedback'),
        productTemplate: document.getElementById('product-card-template'),
        quoteTemplate: document.getElementById('quote-item-template'),
        quoteList: document.getElementById('quote-list'),
        quoteEmpty: document.getElementById('quote-empty'),
        discount: document.getElementById('discount'),
        summarySubtotal: document.getElementById('summary-subtotal'),
        summaryDiscount: document.getElementById('summary-discount'),
        summaryNet: document.getElementById('summary-net'),
        summaryVat: document.getElementById('summary-vat'),
        summaryTotal: document.getElementById('summary-total'),
        generatePdf: document.getElementById('generate-pdf'),
      };

      document.addEventListener('DOMContentLoaded', () => {
        loadCatalogue();
        elements.search.addEventListener('input', handleSearch);
        elements.discount.addEventListener('input', handleDiscountChange);
        elements.generatePdf.addEventListener('click', generatePdf);
      });

      async function loadCatalogue() {
        toggleFeedback('Chargement du catalogue en cours...', 'info');
        try {
          const response = await fetch(catalogueUrl);
          if (!response.ok) {
            throw new Error(`Impossible de charger le fichier (${response.status})`);
          }
          const csvText = await response.text();
          const entries = parseCsv(csvText);
          state.catalogue = entries
            .map(toProduct)
            .filter((item) => item && item.name);
          state.catalogue.forEach((product) => state.catalogueById.set(product.id, product));
          state.filtered = [...state.catalogue];
          renderProducts();
          toggleFeedback('', 'hide');
        } catch (error) {
          console.error(error);
          toggleFeedback("Une erreur est survenue lors du chargement du catalogue. Vérifiez le fichier CSV et réessayez.", 'error');
        }
      }

      function parseCsv(text, delimiter = ';') {
        const lines = text.split(/\r?\n/).filter((line) => line.trim().length > 0);
        if (!lines.length) return [];
        const headers = splitCsvLine(lines.shift(), delimiter).map(slugifyHeader);
        return lines.map((line) => {
          const cells = splitCsvLine(line, delimiter);
          const entry = {};
          headers.forEach((header, index) => {
            entry[header] = (cells[index] ?? '').trim();
          });
          return entry;
        });
      }

      function splitCsvLine(line, delimiter) {
        const cells = [];
        let current = '';
        let insideQuotes = false;
        for (let index = 0; index < line.length; index += 1) {
          const char = line[index];
          if (char === '"') {
            const nextChar = line[index + 1];
            if (insideQuotes && nextChar === '"') {
              current += '"';
              index += 1;
            } else {
              insideQuotes = !insideQuotes;
            }
          } else if (char === delimiter && !insideQuotes) {
            cells.push(current.trim().replace(/^\"|\"$/g, ''));
            current = '';
          } else {
            current += char;
          }
        }
        cells.push(current.trim().replace(/^\"|\"$/g, ''));
        return cells;
      }

      function slugifyHeader(header) {
        return header
          .toLowerCase()
          .normalize('NFD')
          .replace(/[\u0300-\u036f]/g, '')
          .replace(/[^a-z0-9]+/g, '_')
          .replace(/^_|_$/g, '');
      }

      function toProduct(entry) {
        if (!entry || !entry.id_produit_sellsy) return null;
        const name = entry.nom_commercial || '';
        const reference = entry.reference || entry.id_produit_sellsy;
        const description = entry.description || '';
        const rawPrice = entry.tarif_plein || entry.prix_reference_ht || '0';
        const price = parseFrenchNumber(rawPrice);
        const image = entry.image || '';
        const link = entry.lien || '';
        return {
          id: entry.id_produit_sellsy,
          reference,
          name,
          description,
          price,
          priceLabel: currencyFormatter.format(price),
          unit: (entry.unite || '').trim(),
          image,
          link,
        };
      }

      function handleSearch(event) {
        const query = event.target.value.trim().toLowerCase();
        if (!query) {
          state.filtered = [...state.catalogue];
        } else {
          state.filtered = state.catalogue.filter((product) => {
            const haystack = `${product.name} ${product.reference}`.toLowerCase();
            return haystack.includes(query);
          });
        }
        renderProducts();
      }

      function renderProducts() {
        const { productGrid } = elements;
        productGrid.innerHTML = '';
        if (!state.filtered.length) {
          const empty = document.createElement('div');
          empty.className = 'col-span-full rounded-2xl border border-dashed border-slate-200 bg-white p-8 text-center text-sm text-slate-500';
          empty.textContent = 'Aucun produit ne correspond à votre recherche.';
          productGrid.appendChild(empty);
          return;
        }
        const fragment = document.createDocumentFragment();
        for (const product of state.filtered) {
          const card = elements.productTemplate.content.firstElementChild.cloneNode(true);
          const image = card.querySelector('.product-image');
          image.src = product.image || defaultImage;
          image.alt = product.name;
          image.addEventListener('error', () => {
            image.src = defaultImage;
          });
          card.querySelector('.product-reference').textContent = product.reference;
          card.querySelector('.product-name').textContent = product.name;
          card.querySelector('.product-description').textContent = product.description || 'Pas de description fournie.';
          card.querySelector('.product-price').textContent = product.priceLabel;
          const unit = card.querySelector('.product-unit');
          const unitLabel = getDisplayUnit(product.unit);
          unit.textContent = unitLabel ? `Unité : ${unitLabel}` : '';
          const link = card.querySelector('.product-link');
          if (product.link) {
            link.href = product.link;
            link.classList.remove('hidden');
          } else {
            link.classList.add('hidden');
            link.removeAttribute('href');
          }
          const button = card.querySelector('.add-to-quote');
          button.dataset.productId = product.id;
          button.addEventListener('click', () => addToQuote(product.id));
          fragment.appendChild(card);
        }
        productGrid.appendChild(fragment);
      }

      function addToQuote(productId) {
        const product = state.catalogueById.get(productId);
        if (!product) return;
        const existing = state.quote.get(productId);
        if (existing) {
          if (!isAreaUnit(existing.unit)) {
            existing.quantity += 1;
          }
        } else {
          const isArea = isAreaUnit(product.unit);
          const newItem = {
            ...product,
            quantity: 1,
          };
          if (isArea) {
            newItem.length = 1;
            newItem.width = 1;
            updateAreaItemQuantity(newItem);
          }
          state.quote.set(productId, newItem);
        }
        renderQuote();
      }

      function renderQuote() {
        if (!state.quote.size) {
          elements.quoteEmpty.classList.remove('hidden');
          elements.quoteList.classList.add('hidden');
          elements.quoteList.innerHTML = '';
        } else {
          elements.quoteEmpty.classList.add('hidden');
          elements.quoteList.classList.remove('hidden');
          const fragment = document.createDocumentFragment();
          for (const item of state.quote.values()) {
            const node = elements.quoteTemplate.content.firstElementChild.cloneNode(true);
            node.querySelector('.quote-name').textContent = item.name;
            node.querySelector('.quote-reference').textContent = item.reference;
            const unitLabel = getDisplayUnit(item.unit);
            node.querySelector('.quote-unit').textContent = unitLabel ? `Unité : ${unitLabel}` : 'Unité : -';
            const unitControls = node.querySelector('[data-role="unit-controls"]');
            const areaControls = node.querySelector('[data-role="area-controls"]');
            const quantityDisplay = node.querySelector('.quantity');
            if (isAreaUnit(item.unit)) {
              unitControls.classList.add('hidden');
              areaControls.classList.remove('hidden');
              const lengthInput = areaControls.querySelector('.length-input');
              const widthInput = areaControls.querySelector('.width-input');
              const areaValue = areaControls.querySelector('.area-value');
              lengthInput.value = formatNumberForInput(item.length ?? 0);
              widthInput.value = formatNumberForInput(item.width ?? 0);
              areaValue.textContent = `${numberFormatter.format(item.quantity)} ${unitLabel || ''}`.trim();
              lengthInput.addEventListener('input', (event) => handleDimensionChange(item.id, 'length', event.target.value));
              widthInput.addEventListener('input', (event) => handleDimensionChange(item.id, 'width', event.target.value));
            } else {
              unitControls.classList.remove('hidden');
              areaControls.classList.add('hidden');
              quantityDisplay.textContent = unitLabel ? `${item.quantity} ${unitLabel}` : item.quantity;
              node.querySelector('.decrease').addEventListener('click', () => changeQuantity(item.id, -1));
              node.querySelector('.increase').addEventListener('click', () => changeQuantity(item.id, 1));
            }
            node.querySelector('.unit-price').textContent = currencyFormatter.format(item.price);
            node.querySelector('.line-total').textContent = currencyFormatter.format(item.price * item.quantity);
            node.querySelector('.remove-item').addEventListener('click', () => removeItem(item.id));
            fragment.appendChild(node);
          }
          elements.quoteList.innerHTML = '';
          elements.quoteList.appendChild(fragment);
        }
        updateSummary();
      }

      function changeQuantity(productId, delta) {
        const item = state.quote.get(productId);
        if (!item || isAreaUnit(item.unit)) return;
        item.quantity = Math.max(1, item.quantity + delta);
        renderQuote();
      }

      function removeItem(productId) {
        state.quote.delete(productId);
        renderQuote();
      }

      function handleDiscountChange(event) {
        const value = parseFloat(String(event.target.value).replace(',', '.'));
        if (Number.isNaN(value) || value < 0) {
          state.discountRate = 0;
        } else {
          state.discountRate = Math.min(value, 100);
        }
        event.target.value = String(state.discountRate).replace('.', ',');
        updateSummary();
      }

      function updateSummary() {
        const items = Array.from(state.quote.values());
        const subtotal = items.reduce((total, item) => total + item.price * item.quantity, 0);
        const discountAmount = subtotal * (state.discountRate / 100);
        const net = subtotal - discountAmount;
        const vat = net * state.vatRate;
        const total = net + vat;
        elements.summarySubtotal.textContent = currencyFormatter.format(subtotal);
        elements.summaryDiscount.textContent = `-${currencyFormatter.format(discountAmount)}`;
        elements.summaryNet.textContent = currencyFormatter.format(net);
        elements.summaryVat.textContent = currencyFormatter.format(vat);
        elements.summaryTotal.textContent = currencyFormatter.format(total);
      }

      function generatePdf() {
        if (!state.quote.size) {
          toggleFeedback('Ajoutez au moins un article avant de générer le devis.', 'warning');
          return;
        }
        toggleFeedback('', 'hide');
        const items = Array.from(state.quote.values());
        const subtotal = items.reduce((sum, item) => sum + item.price * item.quantity, 0);
        const discountAmount = subtotal * (state.discountRate / 100);
        const net = subtotal - discountAmount;
        const vat = net * state.vatRate;
        const total = net + vat;
        const today = new Date();
        const quoteNumber = `DEV-${today.getFullYear()}${String(today.getMonth() + 1).padStart(2, '0')}${String(today.getDate()).padStart(2, '0')}-${String(today.getHours()).padStart(2, '0')}${String(today.getMinutes()).padStart(2, '0')}`;
        const creationDate = today.toLocaleDateString('fr-FR');
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({ unit: 'pt', format: 'a4' });
        const margin = 48;
        const pageWidth = doc.internal.pageSize.getWidth();
        const pageHeight = doc.internal.pageSize.getHeight();
        const headerHeight = 220;

        const drawHeader = () => {
          doc.setFont('helvetica', 'bold');
          doc.setFontSize(20);
          doc.setTextColor(37, 99, 235);
          doc.text(companyProfile.name, margin, 60);
          doc.setFont('helvetica', 'normal');
          doc.setFontSize(10);
          doc.setTextColor(71, 85, 105);
          doc.text(companyProfile.address.join('\n'), margin, 80);
          const companyContacts = [`Email : ${companyProfile.email}`, `Téléphone : ${companyProfile.phone}`, `Site : ${companyProfile.website}`];
          doc.text(companyContacts.join('\n'), margin, 130);

          doc.setFont('helvetica', 'bold');
          doc.setFontSize(16);
          doc.setTextColor(37, 99, 235);
          doc.text('DEMANDE DE DEVIS', pageWidth - margin, 60, { align: 'right' });
          doc.setFont('helvetica', 'normal');
          doc.setFontSize(11);
          doc.setTextColor(71, 85, 105);
          doc.text(`Devis n° ${quoteNumber}`, pageWidth - margin, 84, { align: 'right' });
          doc.text(`Date : ${creationDate}`, pageWidth - margin, 100, { align: 'right' });
          doc.text(`Remise appliquée : ${numberFormatter.format(state.discountRate)} %`, pageWidth - margin, 116, { align: 'right' });

          doc.setDrawColor(203, 213, 225);
          doc.line(margin, 128, pageWidth - margin, 128);

          doc.setFont('helvetica', 'bold');
          doc.setFontSize(12);
          doc.setTextColor(37, 99, 235);
          doc.text('Destinataire', margin, 150);
          doc.setFont('helvetica', 'normal');
          doc.setFontSize(10);
          doc.setTextColor(71, 85, 105);
          const clientLines = [clientProfile.company, clientProfile.contact, clientProfile.address, clientProfile.city, clientProfile.email].filter(Boolean);
          doc.text(clientLines.join('\n'), margin, 168);

          doc.setDrawColor(226, 232, 240);
          doc.line(margin, headerHeight - 40, pageWidth - margin, headerHeight - 40);
        };

        const drawFooter = () => {
          const footerY = pageHeight - 60;
          doc.setDrawColor(226, 232, 240);
          doc.line(margin, footerY, pageWidth - margin, footerY);
          doc.setFont('helvetica', 'normal');
          doc.setFontSize(9);
          doc.setTextColor(100, 116, 139);
          const legalLine = [companyProfile.legalName, companyProfile.registration, companyProfile.vatNumber].filter(Boolean).join(' • ');
          if (legalLine) {
            doc.text(legalLine, margin, footerY + 16);
          }
          if (companyProfile.bankDetails) {
            doc.text(`Coordonnées bancaires : ${companyProfile.bankDetails}`, margin, footerY + 32);
          }
          doc.text(`Page ${doc.internal.getNumberOfPages()}`, pageWidth - margin, footerY + 32, { align: 'right' });
        };

        const body = items.map((item) => {
          const unitLabel = getDisplayUnit(item.unit) || '—';
          const lines = [item.name];
          if (item.description) {
            lines.push(item.description);
          }
          if (isAreaUnit(item.unit)) {
            const lengthLabel = unitFormatter.format(item.length ?? 0);
            const widthLabel = unitFormatter.format(item.width ?? 0);
            lines.push(`Dimensions retenues : ${lengthLabel} m x ${widthLabel} m`);
            lines.push(`Surface retenue : ${numberFormatter.format(item.quantity)} ${unitLabel}`);
          }
          return [
            item.reference,
            lines.join('\n'),
            numberFormatter.format(item.quantity),
            unitLabel,
            numberFormatter.format(item.price),
            numberFormatter.format(item.price * item.quantity),
          ];
        });

        doc.autoTable({
          startY: headerHeight,
          head: [['Référence', 'Désignation', 'Quantité', 'Unité', 'PU HT (€)', 'Total HT (€)']],
          body,
          styles: { font: 'helvetica', fontSize: 10, cellPadding: 6, textColor: [71, 85, 105] },
          headStyles: { fillColor: [37, 99, 235], textColor: 255, fontStyle: 'bold' },
          columnStyles: {
            0: { cellWidth: 80 },
            1: { cellWidth: 200 },
            2: { halign: 'center', cellWidth: 70 },
            3: { halign: 'center', cellWidth: 70 },
            4: { halign: 'right', cellWidth: 90 },
            5: { halign: 'right', cellWidth: 90 },
          },
          alternateRowStyles: { fillColor: [248, 250, 252] },
          margin: { left: margin, right: margin, top: headerHeight },
          didDrawPage: () => {
            drawHeader();
            drawFooter();
          },
        });

        let y = doc.lastAutoTable.finalY + 24;
        doc.setFont('helvetica', 'bold');
        doc.setFontSize(12);
        doc.setTextColor(37, 99, 235);
        doc.text('Récapitulatif financier', margin, y);
        y += 18;
        doc.setTextColor(71, 85, 105);
        const summaryRows = [
          ['Total HT', currencyFormatter.format(subtotal)],
          [`Remise (${numberFormatter.format(state.discountRate)} %)` , `-${currencyFormatter.format(discountAmount)}`],
          ['Base HT après remise', currencyFormatter.format(net)],
          [`TVA (${numberFormatter.format(state.vatRate * 100)} %)` , currencyFormatter.format(vat)],
          ['Total TTC', currencyFormatter.format(total)],
        ];
        summaryRows.forEach((row, index) => {
          const isLast = index === summaryRows.length - 1;
          doc.setFont('helvetica', isLast ? 'bold' : 'normal');
          doc.setFontSize(isLast ? 12 : 10);
          doc.text(row[0], margin, y);
          doc.text(row[1], pageWidth - margin, y, { align: 'right' });
          y += isLast ? 22 : 16;
        });

        y += 8;
        doc.setFont('helvetica', 'bold');
        doc.setFontSize(11);
        doc.setTextColor(37, 99, 235);
        doc.text('Informations complémentaires', margin, y);
        y += 16;
        doc.setFont('helvetica', 'normal');
        doc.setFontSize(9);
        doc.setTextColor(71, 85, 105);
        doc.text(`Validité du devis : ${companyProfile.validity}`, margin, y);
        y += 14;
        doc.text(`Conditions de paiement : ${companyProfile.paymentTerms}`, margin, y);
        y += 14;
        if (companyProfile.bankDetails) {
          doc.text(`Coordonnées bancaires : ${companyProfile.bankDetails}`, margin, y);
          y += 14;
        }

        doc.setFont('helvetica', 'italic');
        doc.setFontSize(10);
        doc.text('Merci pour votre confiance.', margin, y + 10);

        doc.save(`devis-${quoteNumber}.pdf`);
      }

      function normaliseUnit(unit) {
        return (unit || '').toString().trim().toLowerCase();
      }

      function isAreaUnit(unit) {
        const normalised = normaliseUnit(unit);
        if (!normalised) return false;
        if (areaUnits.has(normalised)) return true;
        return normalised.replace(/\s+/g, '') === 'm2';
      }

      function getDisplayUnit(unit) {
        const normalised = normaliseUnit(unit);
        if (!normalised) return '';
        if (isAreaUnit(unit)) {
          return 'm²';
        }
        const catalogue = new Map([
          ['ml', 'ML'],
          ['piece', 'PIÈCE'],
          ['pièce', 'PIÈCE'],
        ]);
        if (catalogue.has(normalised)) {
          return catalogue.get(normalised);
        }
        return unit.toUpperCase();
      }

      function formatNumberForInput(value) {
        if (!Number.isFinite(value)) return '';
        const rounded = Math.max(0, Number(value));
        return String(Number(rounded.toFixed(2)));
      }

      function handleDimensionChange(productId, dimension, rawValue) {
        const item = state.quote.get(productId);
        if (!item || !isAreaUnit(item.unit)) return;
        const parsed = Math.max(0, parseFrenchNumber(String(rawValue)));
        item[dimension] = parsed;
        updateAreaItemQuantity(item);
        renderQuote();
      }

      function updateAreaItemQuantity(item) {
        const length = Number.isFinite(item.length) ? item.length : 0;
        const width = Number.isFinite(item.width) ? item.width : 0;
        const area = Math.max(0, length * width);
        item.quantity = parseFloat(area.toFixed(2));
      }

      function toggleFeedback(message, type = 'info') {
        const box = elements.productFeedback;
        if (!message || type === 'hide') {
          box.classList.add('hidden');
          box.textContent = '';
          return;
        }
        const styles = {
          info: 'bg-blue-50 text-blue-700 border border-blue-100',
          warning: 'bg-amber-50 text-amber-700 border border-amber-100',
          error: 'bg-rose-50 text-rose-700 border border-rose-100',
        };
        box.className = `rounded-2xl px-6 py-4 text-sm shadow-sm ${styles[type] || styles.info}`;
        box.textContent = message;
        box.classList.remove('hidden');
      }

      function parseFrenchNumber(value) {
        if (!value) return 0;
        const normalised = value.replace(/\s/g, '').replace(',', '.');
        const parsed = parseFloat(normalised);
        return Number.isFinite(parsed) ? parsed : 0;
      }
    </script>
  </body>
</html>
